# if you put the value in a CWFT as a workflow.param.$value then you are not allowed to
# change the value that was submitted from the cli invocation of the workflow
# todo need a secret for ci-secrets with keys for cloning (manually create with other K3D secrets)
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: cwft-git
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  templates:
  - name: git-checkout-with-gitops
    inputs:
      parameters:
      - name: appName
        value: "{{workflow.parameters.appName}}"
      - name: appRepoUrl
        value: "{{workflow.parameters.gitServerUrl}}/{{workflow.parameters.gitOwner}}/{{workflow.parameters.appName}}"
      - name: gitopsRepoUrl
        value: "{{workflow.parameters.gitServerUrl}}/{{workflow.parameters.gitOwner}}/gitops"
      - name: branch
        value: "{{workflow.parameters.branch}}"
      artifacts:
      - name: app-source
        path: "/src/{{inputs.parameters.appName}}"
        git:
          repo: "{{inputs.parameters.appRepoUrl}}"
          branch: "{{inputs.parameters.branch}}"
          singleBranch: true
          usernameSecret:
            name: ci-secrets
            key: username
          passwordSecret:
            name: ci-secrets
            key: password
      - name: gitops-source
        path: /src/gitops
        git:
          repo: "{{inputs.parameters.gitopsRepoUrl}}"
          branch: main
          singleBranch: true
          usernameSecret:
            name: ci-secrets
            key: username
          passwordSecret:
            name: ci-secrets
            key: password
    container:
      image: golang:latest
      command: ["sh", "-c"]
      workingDir: /src
      args:
      - ls -la {{inputs.parameters.appName}};
        ls -la gitops;
    outputs:
      artifacts:
      - name: repo-source
        path: /src
  - name: pull-commit-push
    retryStrategy:
      limit: "5"
    inputs:
      artifacts:
      - name: repo-source
        path: /src
      parameters:
      - name: repoName
      - name: commitMessage
      - name: gitOwner
        value: "{{workflow.parameters.gitOwner}}"
    container:
      image: golang:latest
      command: ["sh", "-c"]
      workingDir: "/src/{{inputs.parameters.repoName}}"
      envFrom:
      - secretRef:
          name: ci-secrets
      # todo tokenize user.email and user.name before putting in gitops-template
      # todo review last two git commands
      args:
      - git remote set-url origin https://${username}:${password}@github.com/{{inputs.parameters.gitOwner}}/{{inputs.parameters.repoName}}.git >/dev/null 2>&1;
        git remote -v;
        git config --global user.email 'jared@kshop.io';
        git config --global user.name 'jarededwards';
        git status;
        git pull --ff-only;
        git add .;
        git commit -m "{{inputs.parameters.commitMessage}}" || echo "Assuming this was committed on previous run, not erroring out";
        git push || bash -c "sleep 10 && echo 'waiting before trying again' && exit 1";